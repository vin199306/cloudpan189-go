name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'
        
    - name: Get version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
      
    - name: Build binaries
      run: |
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p builds
        
        # å®šä¹‰æ„å»ºç›®æ ‡
        TARGETS=(
          "linux/amd64"
          "linux/arm64" 
          "linux/386"
          "linux/arm"
          "linux/mips64"
          "linux/mips64le"
          "windows/amd64"
          "windows/386"
          "darwin/amd64"
          "darwin/arm64"
          "android/arm64"
        )
        
        # æ„å»ºæ¯ä¸ªç›®æ ‡
        for target in "${TARGETS[@]}"; do
          GOOS=${target%/*}
          GOARCH=${target#*/}
          
          # è®¾ç½®è¾“å‡ºæ–‡ä»¶å
          OUTPUT_NAME="cloudpan189-go"
          if [ "$GOOS" = "windows" ]; then
            OUTPUT_NAME+=".exe"
          fi
          
          # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
          echo "Building for $GOOS/$GOARCH..."
          CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build -a -ldflags '-extldflags "-static" -checklinkname=0' -o builds/${OUTPUT_NAME} .
          
          # åˆ›å»ºå‹ç¼©åŒ…
          ARCHIVE_NAME="cloudpan189-go-${{ steps.get_version.outputs.VERSION }}-${GOOS}-${GOARCH}"
          if [ "$GOOS" = "windows" ]; then
            cd builds && zip -r ${ARCHIVE_NAME}.zip ${OUTPUT_NAME} && cd ..
          else
            cd builds && tar -czf ${ARCHIVE_NAME}.tar.gz ${OUTPUT_NAME} && cd ..
          fi
          
          # æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶
          rm builds/${OUTPUT_NAME}
        done
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: CloudPan189-Go ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## CloudPan189-Go ${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸ†• v1.4.1 ç‰ˆæœ¬æ›´æ–° - å…¼å®¹æ€§å’Œç¨³å®šæ€§ä¿®å¤
          
          #### æœ€æ–°ä¿®å¤ (v1.4.1)
          - ğŸ”§ **ä¿®å¤ç¼–è¯‘å…¼å®¹æ€§é—®é¢˜**ï¼šè§£å†³ Go 1.23+ ç¯å¢ƒä¸‹çš„ "invalid reference to runtime.rawbyteslice" é”™è¯¯
          - ğŸ›¡ï¸ **å¢å¼ºç™»å½•ç¨³å®šæ€§**ï¼šæ·»åŠ  panic recovery å’Œé‡è¯•æœºåˆ¶ï¼Œé˜²æ­¢ç™»å½•è¿‡ç¨‹å´©æºƒ
          - âš¡ **ä¼˜åŒ–é”™è¯¯å¤„ç†**ï¼šæ”¹è¿›ç™»å½•å¤±è´¥æ—¶çš„é”™è¯¯æç¤ºå’Œç”¨æˆ·å¼•å¯¼
          - ğŸ—ï¸ **CI/CD ä¼˜åŒ–**ï¼šæ›´æ–° GitHub Actions ä½¿ç”¨ Go 1.22ï¼Œç¡®ä¿è‡ªåŠ¨åŒ–æ„å»ºç¨³å®šæ€§
          
          #### v1.4 æ ¸å¿ƒä¿®å¤
          - ğŸ”§ **ä¿®å¤ç™»å½•è®¤è¯å¤±è´¥é—®é¢˜**ï¼šè§£å†³ "index out of range [1] with length 0" å´©æºƒé”™è¯¯
          - âœ… **è§£å†³ "æœªç™»å½•è´¦å·" é”™è¯¯**ï¼šä¿®å¤ç”¨æˆ·åœ¨ APP ç™»å½•æˆåŠŸåä»æ˜¾ç¤ºæœªç™»å½•çš„é—®é¢˜  
          - âš¡ **å®ç°åˆæˆä»¤ç‰Œå›é€€ç³»ç»Ÿ**ï¼šå½“ç½‘é¡µ Cookie è·å–å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ APP ä»¤ç‰Œç»´æŒå®Œæ•´åŠŸèƒ½
          - ğŸ“± **å®Œå…¨å‘åå…¼å®¹**ï¼šç°æœ‰ç”¨æˆ·æ— éœ€ä»»ä½•æ“ä½œï¼Œæ–°ç”¨æˆ·è‡ªåŠ¨äº«å—ä¿®å¤åçš„ç¨³å®šç™»å½•ä½“éªŒ
          
          #### æ”¯æŒå¹³å°
          - **Linux**: amd64, arm64, 386, arm, mips64, mips64le
          - **Windows**: amd64, 386  
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          - **Android**: arm64
          
          #### å®‰è£…è¯´æ˜
          1. æ ¹æ®ä½ çš„ç³»ç»Ÿæ¶æ„ä¸‹è½½å¯¹åº”çš„å‹ç¼©åŒ…
          2. è§£å‹åè¿è¡Œ `cloudpan189-go` å³å¯ä½¿ç”¨
          3. é¦–æ¬¡ä½¿ç”¨è¯·è¿è¡Œ `cloudpan189-go login` è¿›è¡Œç™»å½•
          
          è¯¦ç»†æŠ€æœ¯è¯´æ˜è¯·æŸ¥çœ‹ï¼š[README-v1.4.md](https://github.com/MaurUppi/cloudpan189-go/blob/master/README-v1.4.md)
        files: builds/*
        draft: false
        prerelease: false
        make_latest: true